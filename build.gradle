plugins {
    id 'java-library'
    id 'scala'
    id 'com.github.hierynomus.license' version '0.16.3-63da64d' apply false
    id 'com.gradleup.shadow' version '9.2.2' apply false
    id 'com.github.alisiikh.scalastyle' version '3.5.0' apply false
    id 'me.champeau.jmh' version '0.7.3' apply false
    id "ch.kk7.spawn" version "1.0.20180924200750" apply false
}

apply from: 'build.params.gradle'
apply plugin: 'base'

allprojects {
    java {
        sourceCompatibility = ver.jvm
        targetCompatibility = ver.jvm
    }

    scala {
        scalaVersion = ver.scala.full
    }

    group = 'org.opencypher'
    version = ver.self
}

apply from: 'build.licenses.gradle'

subprojects {
    apply plugin: 'scala'
    apply plugin: 'java-library'

    repositories {
        mavenCentral()
        mavenLocal()
    }

    dependencies {
        implementation group: 'org.scala-lang', name: 'scala-library', version: ver.scala.full

        // Seems we need to lock these down, otherwise we get runtime errors on reflection
        implementation group: 'org.scala-lang', name: 'scala-reflect', version: ver.scala.full
        implementation group: 'org.scala-lang', name: 'scala-compiler', version: ver.scala.full

        implementation group: 'org.apache.logging.log4j', name: 'log4j-api', version: ver.log4j.main
        implementation group: 'org.apache.logging.log4j', name: "log4j-api-scala".scala(), version: ver.log4j.scala

        testImplementation group: 'org.apache.logging.log4j', name: 'log4j-core', version: ver.log4j.main
        testImplementation group: 'org.scalatest', name: "scalatest".scala(), version: ver.scalatest
        testImplementation group: 'org.scalacheck', name: "scalacheck".scala(), version: ver.scalacheck
        testImplementation group: 'junit', name: 'junit', version: ver.junit.main
        testImplementation group: 'org.mockito', name: 'mockito-all', version: ver.mockito
        testRuntimeOnly group: 'org.junit.platform', name: 'junit-platform-runner', version: ver.junit.runner
    }

    test {
        useJUnit()
    }

    ext.scalacParameters = [
            '-unchecked',
            '-deprecation',
            '-feature',
            '-Xfatal-warnings',
            '-Xfuture',
            '-Ypartial-unification',
            '-Ywarn-adapted-args'
    ]

    tasks.withType(ScalaCompile) {
        options.encoding = 'UTF-8'
        scalaCompileOptions.additionalParameters = scalacParameters
    }

    tasks.withType(ScalaDoc) {
        scalaDocOptions.additionalParameters = scalacParameters
    }

    task sourceJar(type: Jar) {
        archiveClassifier = 'sources'
        from(sourceSets.main.allSource)
    }

    task docJar(type: Jar) {
        dependsOn tasks.scaladoc
        archiveClassifier = 'javadoc'
        from(tasks.scaladoc.destinationDir)
    }

    task testJar(type: Jar) {
        archiveClassifier = 'tests'
        from(sourceSets.test.output)
    }

    tasks.withType(Jar) {
        from(tasks.generateLicensesFiles) {
            into("META-INF/")
        }
    }

    task licenseFile {
        outputs.file(project.parent.file('LICENSE.txt'))
    }

    task dependencySearch(type: DependencyInsightReportTask) {
        description = 'Searches all projects for a dependency'
        group = 'help'
    }

    task runApp {
        dependsOn tasks.classes
        group = 'run'
        description = 'Run a custom Scala app (use -PmainClass=com.my.package.App)'
        doLast {
            javaexec {
                classpath = sourceSets.main.runtimeClasspath
                main = project.getProperty("mainClass")
            }
        }
    }

    // copied from https://stackoverflow.com/a/38058671/568723
    task depSize  {
        description = 'Lists all dependencies sorted by their size'
        doLast {
            final formatStr = "%,10.2f"
            final conf = configurations.default
            final size = conf.collect { it.length() / (1024 * 1024) }.sum()
            final out = new StringBuffer()
            out << 'Total dependencies size:'.padRight(45)
            out << "${String.format(formatStr, size)} Mb\n\n"
            conf.sort { -it.length() }
                    .each {
                        out << "${it.name}".padRight(45)
                        out << "${String.format(formatStr, (it.length() / 1024))} kb\n"
                    }
            println(out)
        }
    }
}

apply from: 'build.publishing.gradle'
apply from: 'build.style.gradle'
